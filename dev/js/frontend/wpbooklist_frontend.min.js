/**
 * JavaScript Admin Functions - wpbooklist-frontend.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  6.0.0
 */

console.log( 'This is the JavaScript Object that holds all PHP Variables for use in JavaScript' );
console.log( wpbooklistPhpVariables );


// All functions wrapped in jQuery(document).ready()...
jQuery( document ).ready( function( $ ) {
	'use strict';

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	//Handles various aestetic functions for the front end
	wpbooklistSearchBoxClear();

	// Handles the Read More links functionality for Posts
	wpbooklistReadMorePosts();

	// Handles the Read More links functionality for Pages
	wpbooklistReadMorePages();

	// Function that opens the book up in Colorbox.
	wpbooklistShowBookInColorbox();

	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */


	// Handles the clearing of the frontend search box on click
	function wpbooklistSearchBoxClear() {

		// Clears the frontend search box on click if it has it's default value.
		$( document ).on( 'click', '.wpbooklist-search-text-class', function( event ) {
			if ( wpbooklistPhpVariables.trans1 + '...' == $( this ).val() ) {
				$( this ).val( '' );
			}
		});
	}

	// Handles the Read More links functionality for Posts
	function wpbooklistReadMorePosts() {

		// Enables the 'Read More' link for the description block in a post utilizing the readmore.js file
		$( '#wpbl-posttd-book-description-contents' ).readmore({
			speed: 175,
			heightMargin: 16,
			collapsedHeight: 100,
			moreLink: '<a href="#">Read more</a>',
			lessLink: '<a href="#">Read less</a>'
		});

		// Enables the 'Read More' link for the notes block in a post utilizing the readmore.js file
		$( '#wpbl-posttd-book-notes-contents' ).readmore({
			speed: 75,
			heightMargin: 16,
			collapsedHeight: 100,
			moreLink: '<a href="#">Read more</a>',
			lessLink: '<a href="#">Read less</a>'
		});

	}

	// Handles the Read More links functionality for Pages
	function wpbooklistReadMorePages() {

		// Enables the 'Read More' link for the description block in a post utilizing the readmore.js file
		$( '#wpbl-pagetd-book-description-contents' ).readmore({
			speed: 175,
			heightMargin: 16,
			collapsedHeight: 100,
			moreLink: '<a href="#">Read more</a>',
			lessLink: '<a href="#">Read less</a>'
		});

		// Enables the 'Read More' link for the notes block in a post utilizing the readmore.js file
		$( '#wpbl-pagetd-book-notes-contents' ).readmore({
			speed: 75,
			heightMargin: 16,
			collapsedHeight: 100,
			moreLink: '<a href="#">Read more</a>',
			lessLink: '<a href="#">Read less</a>'
		});
	}

	// Function that opens the book up in Colorbox.
	function wpbooklistShowBookInColorbox(){
		$(document).on("click",".wpbooklist-show-book-colorbox", function(event){
			event.preventDefault ? event.preventDefault() : event.returnValue = false;
	  		var bookId = $(this).attr('data-bookid');
	  		var bookTable = $(this).attr('data-booktable');

	  		var brandingtext1 = $('#wpbooklist-branding-text-1').attr('data-value');
	  		if(brandingtext1 == undefined){
	  			brandingtext1 = '';
	  		}
	  		var brandingtext2 = $('#wpbooklist-branding-text-2').attr('data-value');
	  		if(brandingtext2 == undefined){
	  			brandingtext2 = '';
	  		}
	  		var brandinglogo1 = $('#wpbooklist-branding-logo-1').attr('data-value');
	  		if(brandinglogo1 == undefined){
	  			brandinglogo1 = '';
	  		}
	  		var brandinglogo2 = $('#wpbooklist-branding-logo-2').attr('data-value');
	  		if(brandinglogo2 == undefined){
	  			brandinglogo2 = '';
	  		}

	  		// The variable to tell colorbox whether this string exists in the url: sortby=alphabeticallybyauthorlast, and if so, to swap around the Author names. 
	  		var sortParam = '';
	  		var url = window.location.href;
	  		if(url.indexOf('sortby=alphabeticallybyauthorlast') > -1){
	  			sortParam = 'true';
	  		}

		  	var data = {
				'action': 'wpbooklist_show_book_in_colorbox_action',
				'security': wpbooklistPhpVariables.adminnonce3,
				'bookId':bookId,
				'bookTable':bookTable,
				'sortParam':sortParam
			};
			console.log(data);

			$.colorbox({
		        iframe:true,
		        title: wpbooklistPhpVariables.trans55, 
		        width: "50%", 
		        height: "80%", 
		        html: "&nbsp;", 
		        fastIframe:false,
		        onComplete:function(){
		        	if(brandinglogo1 != ''){
		        		$('#wpbooklist-branding-img-1-id').remove();
		        		$('#cboxLoadingGraphic').css({'background':'none'})
		        		$('#cboxLoadingGraphic').append('<img style="margin-left: auto;margin-right: auto;display: block;width: 20%;margin-top: 15%;" id="wpbooklist-branding-img-1-id" src="'+brandinglogo1+'" />')
		        		
		        	}

		        	if(brandingtext1 != ''){
		        		$('#wpbooklist-branding-text-1-id').remove();
		        		$('#cboxLoadingGraphic').css({'background':'none'})
		        		$('#cboxLoadingGraphic').append('<p style="text-align: center;font-style: italic;font-size: 17px;font-weight: bold;" id="wpbooklist-branding-text-1-id">'+brandingtext1+'</p>')
		        	}

		        	$('#cboxLoadingGraphic').show();
		            $('#cboxLoadingGraphic').css({'display':'block'})
		        }
		    });

	     	var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	response = response.split('---sep---');
			    	console.log(response[1]);
			    	
			    	$.colorbox({
						open: true,
						preloading: true,
						scrolling: true,
						width:'70%',
						height:'70%',
						html: response[0],
						onClosed:function(){
						  //Do something on close.
						},
						onComplete:function(){

							if(brandinglogo2 != '' && brandingtext2 == ''){
								$('#cboxTitle').css({'border':'solid 1px #e1e1e1','height':'100px','background-color':'white', 'bottom':'-95px'})
								$('#cboxWrapper').css({'overflow':'visible'})
								$('#colorbox').css({'height':($('#colorbox').height()+100)+'px'})
								$('#cboxTitle').append('<img id="wpbooklist-branding-logo-2-id" style="width:50px; margin-top:20px;" src="'+brandinglogo2+'" />')
							}

							if(brandingtext2 != '' && brandinglogo2 == ''){
								$('#cboxTitle').css({'border':'solid 1px #e1e1e1','height':'100px','background-color':'white', 'bottom':'-95px'})
								$('#cboxWrapper').css({'overflow':'visible'})
								$('#colorbox').css({'height':($('#colorbox').height()+100)+'px'})
								$('#cboxTitle').append('<p style="text-align: center;font-style: italic;font-size: 17px;font-weight: bold;" id="wpbooklist-branding-text-2-id">'+brandingtext2+'</p>')
							}

							if(brandingtext2 != '' && brandinglogo2 != ''){
								$('#cboxTitle').css({'border':'solid 1px #e1e1e1','height':'100px','background-color':'white', 'bottom':'-95px'})
								$('#cboxWrapper').css({'overflow':'visible'})
								$('#colorbox').css({'height':($('#colorbox').height()+100)+'px'})
								$('#cboxTitle').append('<img id="wpbooklist-branding-logo-2-id" style="display:inline-block; margin-right:10px; margin-top:20px; width:50px;" src="'+brandinglogo2+'" /><p style="display:inline-block; text-align: center; margin: 0; bottom: 20px; position: relative; font-style: italic;font-size: 17px;font-weight: bold;" id="wpbooklist-branding-text-2-id">'+brandingtext2+'</p>')
							}

							
							// Hide blank 'Similar Titles' images
							$('.wpbooklist-similar-image').load(function() {
								var image = new Image();
								image.src = $(this).attr("src");
								if(image.naturalHeight == '1'){
									$(this).parent().parent().css({'display':'none'})
								}
							});

							// For the Google Preview in the Google Preview Extension
							function alertInitialized() {
							  //alert("book successfully loaded and initialized!");
							  $('#google-preview-no-results-div').css({'display':'none'})
							  $('#wpbooklist-google-title-id').css({'display':'block'})
							  $('.wpbooklist_google_p_class').css({'display':'block'})
							}

							// For the Google Preview in the Google Preview Extension
							if($('#google-preview-div').length > 0){
								//$('#wpbooklist-google-title-id').css({'display':'none'})
								$('.wpbooklist_google_p_class').css({'display':'none'})
								var viewerDiv = document.getElementById("google-preview-div");
								bookViewer = new google.books.DefaultViewer(viewerDiv);
								var test = bookViewer.load(response[1], null, alertInitialized);
							}


							addthis.toolbox(
				              $(".addthis_sharing_toolbox").get()
				            );
				            addthis.toolbox(
				              $(".addthis_sharing_toolbox").get()
				            );
				            addthis.counter(
				              $(".addthis_counter").get()
				            );
						}
					});


			    },
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(errorThrown);
		            console.log(textStatus);
		            console.log(jqXHR);
				}
			});
	  	});
	}


});
